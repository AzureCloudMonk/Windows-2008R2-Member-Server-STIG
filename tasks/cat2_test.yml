# - name: "MEDIUM | V-1089 | AUDIT | The required legal notice must be configured to display before console logon."
#   win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LegalNoticeText
#   register: legal_notice_audit
#   check_mode: no
#   changed_when: no
#   failed_when: "reg_not_found not in legal_notice_audit.stderr and legal_notice_audit.stderr"
#   tags:
#       - cat2
#       - medium
#       - audit
#       - V-1089

# - name: "MEDIUM | V-1089 | PATCH | The required legal notice must be configured to display before console logon."
#   win_regedit: 
#       key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
#       value: "LegalNoticeText"
#       data: "{{ legal_notice }}"
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-1089

- name: "MEDIUM | V-1141 | AUDIT | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_command: reg query HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnablePlainTextPassword
  register: plain_text_password_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in plain_text_password_audit.stderr and plain_text_password_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1141

- name: "MEDIUM | V-1141 | PATCH | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_regedit: 
      key: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1141

- name: "MEDIUM | V-1154 | AUDIT | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v DisableCAD
  register: disable_CAD_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_CAD_audit.stderr and disable_CAD_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1154

- name: "MEDIUM | V-1154 | PATCH | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System'
      value: DisableCAD
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1154

# - name: "MEDIUM | V-1157 | AUDIT | The Smart Card removal option will be configured to Force Logoff or Lock Workstation."
#   win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v SCRemoveOption
#   register: SC_removal_audit
#   check_mode: no
#   changed_when: no
#   failed_when: "reg_not_found not in SC_removal_audit.stderr and SC_removal_audit.stderr"
#   tags:
#       - cat2
#       - medium
#       - audit
#       - V-1157

# - name: "MEDIUM | V-1157 | PATCH | The Smart Card removal option will be configured to Force Logoff or Lock Workstation."
#   win_regedit: 
#       key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
#       value: SCRemoveOption
#       data: 1
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-1157

- name: "MEDIUM | V-1162 | AUDIT | The Windows SMB server will perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v EnableSecuritySignature
  register: enable_SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_SMB_server_packet_signing_audit.stderr and enable_SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1162

- name: "MEDIUM | V-1162 | PATCH | The Windows SMB server will perform SMB packet signing when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters'
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1162

- name: "MEDIUM | V-1163 | AUDIT | Outgoing secure channel traffic will be encrypted when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SealSecureChannel
  register: encrypt_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_outgoing_secure_channel_audit.stderr and encrypt_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1163

- name: "MEDIUM | V-1163 | PATCH | Outgoing secure channel traffic will be encrypted when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SealSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1163

- name: "MEDIUM | V-1164 | AUDIT | Outgoing secure channel traffic will be signed when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SignSecureChannel
  register: sign_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sign_outgoing_secure_channel_audit.stderr and sign_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1164

- name: "MEDIUM | V-1164 | PATCH | Outgoing secure channel traffic will be signed when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SignSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1164

- name: "MEDIUM | V-1166 | AUDIT | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnableSecuritySignature
  register: enable_SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_SMB_client_packet_signing_audit.stderr and enable_SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1166

- name: "MEDIUM | V-1166 | PATCH | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnableSecuritySignature
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1166

- name: "MEDIUM | V-1171 | AUDIT | Ejection of removable NTFS media is not restricted to Administrators."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AllocateDASD
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1171

- name: "MEDIUM | V-1171 | PATCH | Ejection of removable NTFS media is not restricted to Administrators."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
      value: AllocateDASD
      data: 0
  tags:
      - cat2
      - medium
      - patch
      - V-1171

- name: "MEDIUM | V-3372 | AUDIT | A system must be logged on to before removing from a docking station."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v UndockWithoutLogon
  register: undock_logon_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in undock_logon_audit.stderr and undock_logon_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3372

- name: "MEDIUM | V-3372 | PATCH | A system must be logged on to before removing from a docking station."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System'
      value: UndockWithoutLogon
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3372

- name: "MEDIUM | V-3376 | AUDIT | The system will be configured to prevent the storage of passwords and credentials"
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v DisableDomainCreds
  register: creds_storage_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in creds_storage_audit.stderr and creds_storage_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3376

- name: "MEDIUM | V-3376 | PATCH | The system will be configured to prevent the storage of passwords and credentials"
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: DisableDomainCreds
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3376

- name: "MEDIUM | V-3377 | AUDIT | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v EveryoneIncludesAnonymous
  register: everyone_includes_anon_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in everyone_includes_anon_audit.stderr and everyone_includes_anon_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3377

- name: "MEDIUM | V-3377 | PATCH | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3377

- name: "MEDIUM | V-3378 | AUDIT | The system will be configured to use the Classic security model."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v ForceGuest
  register: classic_security_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in classic_security_audit.stderr and classic_security_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3378

- name: "MEDIUM | V-3378 | PATCH | The system will be configured to use the Classic security model."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: ForceGuest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3378

- name: "MEDIUM | V-3381 | AUDIT | The system will be configured to the required LDAP client signing level."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LDAP /v LDAPClientIntegrity
  register: LDAP_client_integrity_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in LDAP_client_integrity_audit.stderr and LDAP_client_integrity_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3381

- name: "MEDIUM | V-3381 | PATCH | The system will be configured to the required LDAP client signing level."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\LDAP'
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3381

- name: "MEDIUM | V-3382 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinClientSec
  register: NTLM_min_client_sec_audit
  check_mode: no
  changed_when: no #"'0x20080000' not in NTLM_min_client_sec_audit.stdout"
  failed_when: "reg_not_found not in NTLM_min_client_sec_audit.stderr and NTLM_min_client_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3382

# - name: "MEDIUM | V-3382 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-3382

- name: "MEDIUM | V-3385 | AUDIT | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\Kernel\" /v ObCaseInsensitive
  register: case_insensitive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in case_insensitive_audit.stderr and case_insensitive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3385

- name: "MEDIUM | V-3385 | PATCH | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager\Kernel'
      value: ObCaseInsensitive
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3385

- name: "MEDIUM | V-3449 | AUDIT | Remote Desktop Services will limit users to one remote session."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fSingleSessionPerUser
  register: single_rdp_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in single_rdp_audit.stderr and single_rdp_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3449

- name: "MEDIUM | V-3449 | PATCH | Remote Desktop Services will limit users to one remote session."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fSingleSessionPerUser
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3449

- name: "MEDIUM | V-3453 | AUDIT | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fPromptForPassword
  register: rdp_password_prompt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in rdp_password_prompt_audit.stderr and rdp_password_prompt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3453

- name: "MEDIUM | V-3453 | PATCH | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fPromptForPassword
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3453

- name: "MEDIUM | V-3454 | AUDIT | Remote Desktop Services will be configured with the client connection encryption set to the required level."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MinEncryptionLevel
  register: min_encrypt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in min_encrypt_audit.stderr and min_encrypt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3454

# - name: "MEDIUM | V-3454 | PATCH | Remote Desktop Services will be configured with the client connection encryption set to the required level."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-3454

- name: "MEDIUM | V-3455 | AUDIT | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v PerSessionTempDir
  register: temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in temp_folder_audit.stderr and temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3455

- name: "MEDIUM | V-3455 | PATCH | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: PerSessionTempDir
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3455

- name: "MEDIUM | V-3456 | AUDIT | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DeleteTempDirsOnExit
  register: delete_temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in delete_temp_folder_audit.stderr and delete_temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3456

- name: "MEDIUM | V-3456 | PATCH | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DeleteTempDirsOnExit
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3456

- name: "MEDIUM | V-3457 | AUDIT | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxDisconnectionTime
  register: max_disconnection_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_disconnection_time_audit.stderr and max_disconnection_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3457

- name: "MEDIUM | V-3457 | PATCH | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxDisconnectionTime
      data: 0x0000ea60
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3457

- name: "MEDIUM | V-3458 | AUDIT | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxIdleTime
  register: max_idle_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_idle_time_audit.stderr and max_idle_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3458

- name: "MEDIUM | V-3458 | PATCH | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxIdleTime
      data: 0x000dbba0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3458

- name: "MEDIUM | V-3469 | AUDIT | The system will be configured to enable the background refresh of Group Policy."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\system /v DisableBkGndGroupPolicy
  register: background_group_policy_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in background_group_policy_audit.stderr and background_group_policy_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3469

- name: "MEDIUM | V-3469 | PATCH | The system will be configured to enable the background refresh of Group Policy."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\system'
      value: DisableBkGndGroupPolicy
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3469

- name: "MEDIUM | V-3470 | AUDIT | The system will be configured to prevent unsolicited remote assistance offers."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fAllowUnsolicited
  register: unsolicited_remote_assistance_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in unsolicited_remote_assistance_audit.stderr and unsolicited_remote_assistance_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3470

- name: "MEDIUM | V-3470 | PATCH | The system will be configured to prevent unsolicited remote assistance offers."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fAllowUnsolicited
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3470

- name: "MEDIUM | V-3479 | AUDIT | The system will be configured to use Safe DLL Search Mode."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\" /v SafeDllSearchMode
  register: safe_DLL_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in safe_DLL_audit.stderr and safe_DLL_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3479

- name: "MEDIUM | V-3479 | PATCH | The system will be configured to use Safe DLL Search Mode."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager'
      value: SafeDllSearchMode
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3479

- name: "MEDIUM | V-3480 | AUDIT | Media Player must be configured to prevent automatic checking for updates."
  win_command: reg query HKLM\Software\Policies\Microsoft\WindowsMediaPlayer /v DisableAutoupdate
  register: WMP_auto_update_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_auto_update_audit.stderr and WMP_auto_update_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3480

- name: "MEDIUM | V-3480 | PATCH | Media Player must be configured to prevent automatic checking for updates."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: DisableAutoupdate
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3480

- name: "MEDIUM | V-3481 | AUDIT | Media Player will be configured to prevent automatic Codec downloads."
  win_command: reg query HKCU\Software\Policies\Microsoft\WindowsMediaPlayer /v PreventCodecDownload
  register: WMP_codec_download_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_codec_download_audit.stderr and WMP_codec_download_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3481

- name: "MEDIUM | V-3481 | PATCH | Media Player will be configured to prevent automatic Codec downloads."
  win_regedit: 
      key: 'HKCU:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: PreventCodecDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3481

- name: "MEDIUM | V-4444 | AUDIT | Users must be required to enter a password to access private keys stored on the computer."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Cryptography /v ForceKeyProtection
  register: strong_key_protection_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in strong_key_protection_audit.stderr and strong_key_protection_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4444

- name: "MEDIUM | V-4444 | PATCH | Users must be required to enter a password to access private keys stored on the computer."
  win_regedit: 
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Cryptography'
      value: ForceKeyProtection
      data: 2
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4444

- name: "MEDIUM | V-4446 | AUDIT | Software certificate restriction policies will be enforced."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers /v AuthenticodeEnabled
  register: software_restricition_policies_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in software_restricition_policies_audit.stderr and software_restricition_policies_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4446

- name: "MEDIUM | V-4446 | PATCH | Software certificate restriction policies will be enforced."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers'
      value: AuthenticodeEnabled
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4446

- name: "MEDIUM | V-4447 | AUDIT | The Remote Desktop Session Host will require secure RPC communications."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fEncryptRPCTraffic
  register: encrypt_RPC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_RPC_audit.stderr and encrypt_RPC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4447

- name: "MEDIUM | V-4447 | PATCH | The Remote Desktop Session Host will require secure RPC communications."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fEncryptRPCTraffic
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4447

- name: "MEDIUM | V-4448 | AUDIT | Group Policy objects will be reprocessed even if they have not changed."
  win_shell: reg query "HKLM\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}" /v NoGPOListChanges
  register: reprocess_GPO_audit
  check_mode: no
  changed_when: no
  # Special case. Only on 2k8r2, win_command and win_shell do not like '{'. Module errors out.
  failed_when: "'ERROR: Invalid syntax' in reprocess_GPO_audit.module_stdout"
  tags:
      - cat2
      - medium
      - audit
      - V-4448

- name: "MEDIUM | V-4448 | PATCH | Group Policy objects will be reprocessed even if they have not changed."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}'
      value: NoGPOListChanges
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4448

- name: "MEDIUM | V-6831 | AUDIT | Outgoing secure channel traffic will be encrypted or signed."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v RequireSignOrSeal
  register: encrypt_or_sign_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_or_sign_audit.stderr and encrypt_or_sign_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6831

- name: "MEDIUM | V-6831 | PATCH | Outgoing secure channel traffic will be encrypted or signed."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: RequireSignOrSeal
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-6831

- name: "MEDIUM | V-6832 | AUDIT | The Windows SMB client will be enabled to always perform SMB packet signing."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v RequireSecuritySignature
  register: require_SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_SMB_client_packet_signing_audit.stderr and require_SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6832

# - name: "MEDIUM | V-6832 | PATCH | The Windows SMB client will be enabled to always perform SMB packet signing."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-6832

- name: "MEDIUM | V-6833 | AUDIT | The Windows SMB server will be enabled to always perform SMB packet signing."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v RequireSecuritySignature
  register: require_SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_SMB_server_packet_signing_audit.stderr and require_SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6833

# - name: "MEDIUM | V-6833 | PATCH | The Windows SMB server will be enabled to always perform SMB packet signing."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-6833

- name: "MEDIUM | V-14228 | AUDIT | Auditing Access of Global System Objects must be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v AuditBaseObjects
  register: audit_base_objects_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in audit_base_objects_audit.stderr and audit_base_objects_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14228

- name: "MEDIUM | V-14228 | PATCH | Auditing Access of Global System Objects must be turned off."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: AuditBaseObjects
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14228

- name: "MEDIUM | V-14229 | AUDIT | Audit of Backup and Restore Privileges will be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v FullPrivilegeAuditing
  register: full_privilege_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in full_privilege_audit.stderr and full_privilege_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14229

# win_regedit requires 2 octects for binary values to detect if a change is needed or not.
- name: "MEDIUM | V-14229 | PATCH | Audit of Backup and Restore Privileges will be turned off."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: FullPrivilegeAuditing
      data: 0x0,0x0
      datatype: binary
  tags:
      - cat2
      - medium
      - patch
      - V-14229

- name: "MEDIUM | V-14230 | AUDIT | Audit policy using subcategories will be enabled."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v SCENoApplyLegacyAuditPolicy
  register: subcategories_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in subcategories_audit.stderr and subcategories_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14230

- name: "MEDIUM | V-14230 | PATCH | Audit policy using subcategories will be enabled."
  win_regedit: 
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: SCENoApplyLegacyAuditPolicy
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14230

- name: "MEDIUM | V-14234 | AUDIT | User Account Control approval mode for the built-in Administrator will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v FilterAdministratorToken
  register: admin_approval_mode_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in admin_approval_mode_audit.stderr and admin_approval_mode_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14234

# - name: "MEDIUM | V-14234 | PATCH | User Account Control approval mode for the built-in Administrator will be enabled."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14234

- name: "MEDIUM | V-14235 | AUDIT | User Account Control will, at a minimum, prompt administrators for consent."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin
  register: admin_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in admin_consent_audit.stderr and admin_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14235

# - name: "MEDIUM | V-14235 | PATCH | User Account Control will, at a minimum, prompt administrators for consent."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14235

- name: "MEDIUM | V-14236 | AUDIT | User Account Control will automatically deny standard user requests for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorUser
  register: user_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in user_consent_audit.stderr and user_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14236

# - name: "MEDIUM | V-14236 | PATCH | User Account Control will automatically deny standard user requests for elevation."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14236

- name: "MEDIUM | V-14237 | AUDIT | User Account Control will be configured to detect application installations and prompt for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableInstallerDetection
  register: application_installation_credentials_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in application_installation_credentials_audit.stderr and application_installation_credentials_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14237

# - name: "MEDIUM | V-14237 | PATCH | User Account Control will be configured to detect application installations and prompt for elevation."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14237

- name: "MEDIUM | V-14239 | AUDIT | User Account Control will only elevate UIAccess applications that are installed in secure locations"
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableSecureUIAPaths
  register: enable_secure_UIA_paths_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_secure_UIA_paths_audit.stderr and enable_secure_UIA_paths_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14239

# - name: "MEDIUM | V-14239 | PATCH | User Account Control will only elevate UIAccess applications that are installed in secure locations"
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14239

- name: "MEDIUM | V-14240 | AUDIT | User Account Control will run all administrators in Admin Approval Mode, enabling UAC."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
  register: enable_UAC
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_UAC.stderr and enable_UAC.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14240

# - name: "MEDIUM | V-14240 | PATCH | User Account Control will run all administrators in Admin Approval Mode, enabling UAC."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14240

- name: "MEDIUM | V-14241 | AUDIT | User Account Control will switch to the secure desktop when prompting for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v PromptOnSecureDesktop
  register: prompt_on_secure_desktop_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_on_secure_desktop_audit.stderr and prompt_on_secure_desktop_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14241

# - name: "MEDIUM | V-14241 | PATCH | User Account Control will switch to the secure desktop when prompting for elevation."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14241

- name: "MEDIUM | V-14242 | AUDIT | User Account Control will virtualize file and registry write failures to per-user locations."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableVirtualization
  register: UAC_virtualization_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in UAC_virtualization_audit.stderr and UAC_virtualization_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14242

# - name: "MEDIUM | V-14242 | PATCH | User Account Control will virtualize file and registry write failures to per-user locations."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-14242

- name: "MEDIUM | V-14247 | AUDIT | Passwords will not be saved in the Remote Desktop Client."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DisablePasswordSaving
  register: disable_RDC_password_saving_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_RDC_password_saving_audit.stderr and disable_RDC_password_saving_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14247

- name: "MEDIUM | V-14247 | PATCH | Passwords will not be saved in the Remote Desktop Client."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DisablePasswordSaving
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14247

- name: "MEDIUM | V-14249 | AUDIT | Local drives will be prevented from sharing with Remote Desktop Session Hosts (Remote Desktop Services Role)."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableCdm
  register: disable_local_drive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_local_drive_audit.stderr and disable_local_drive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14249

- name: "MEDIUM | V-14249 | PATCH | Local drives will be prevented from sharing with Remote Desktop Session Hosts (Remote Desktop Services Role)."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fDisableCdm
      data: 1
      datatype: dword
  tags:
    - cat2
    - medium
    - patch
    - V-14249

